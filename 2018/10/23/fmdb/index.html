<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="keep to run"><title>FMDB的分析 | Run</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">FMDB的分析</h1><a id="logo" href="/.">Run</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">FMDB的分析</h1><div class="post-meta">Oct 23, 2018<span> | </span><span class="category"><a href="/categories/swift/">swift</a></span></div><div class="post-content"><h3 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h3><p>FMDB 是iOS平台的SQLite数据库框架, 用OC 的方式封装SQLite 的C语言的API. FMDB棉线对象的形式使用, 更加轻量级和灵活, 并且提供了多线程的数据库操作方法.</p>
<a id="more"></a>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><p>FMDB 由以下几个文件组成:<br>FMResultSet: FMDatabase执行查询之后的结果集<br>FMDatabase: 表示一个单独的SQLite 数据库操作实例, 通过它可以对数据库进行增删改查等操作<br>FMDatabaseAdditions: FMDatabase 的扩展类, 新增对查询结果只返回单个值的方法进行简化, 对表列是否存在版本号, 校验SQL等功能<br>FMDatabaseQueue: 使用串行队列, 对多线程的操作进行了支持<br>FMDatabasePool: 使用任务池的形势, 对多线程的操作提供支持, 但是并不推荐  </p>
<h3 id="FMResultSet"><a href="#FMResultSet" class="headerlink" title="FMResultSet"></a>FMResultSet</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">+ (instancetype)resultSetWithStatement:(FMStatement *)statement usingParentDatabase:(FMDatabase*)aDB &#123;</span><br><span class="line">    </span><br><span class="line">    FMResultSet *rs = [[FMResultSet alloc] init]; // 生成结果集对象</span><br><span class="line">    </span><br><span class="line">    [rs setStatement:statement]; // 设置好SQL语句</span><br><span class="line">    [rs setParentDB:aDB]; // 设置好数据库句柄</span><br><span class="line">    </span><br><span class="line">    NSParameterAssert(![statement inUse]);</span><br><span class="line">    [statement setInUse:YES]; // weak reference</span><br><span class="line">    </span><br><span class="line">    return FMDBReturnAutoreleased(rs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>参数 (FMStatement <em>)statement<br>  该对象主要是对sqlite3_stmt 的封装, sqlite3_stmt </em> 所表示的内容尅看作是预处理的sql语句, 以及不是我们熟知的sql 语句. 它已经把sql语句解析了, 用sqlite自己表示记录的内部数据结构</li>
<li>参数 (FMDatabase*)aDB<br>  该结果集所属于的FMDatabase 数据库操作对象</li>
</ul>
<h3 id="结果集的遍历"><a href="#结果集的遍历" class="headerlink" title="结果集的遍历"></a>结果集的遍历</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">对 nextWithError 函数的封装</span><br><span class="line">- (BOOL)next &#123;</span><br><span class="line">    return [self nextWithError:nil];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (BOOL)nextWithError:(NSError * _Nullable __autoreleasing *)outErr &#123;</span><br><span class="line">    // 通过 sqlite3_step 函数对FMStatement 中的sqlite3_stmt 对象进行逐行取值</span><br><span class="line">    int rc = sqlite3_step([_statement statement]);</span><br><span class="line">    </span><br><span class="line">    if (SQLITE_BUSY == rc || SQLITE_LOCKED == rc) &#123;</span><br><span class="line">        NSLog(@&quot;%s:%d Database busy (%@)&quot;, __FUNCTION__, __LINE__, [_parentDB databasePath]);</span><br><span class="line">        NSLog(@&quot;Database busy&quot;);</span><br><span class="line">        if (outErr) &#123;</span><br><span class="line">            *outErr = [_parentDB lastError];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else if (SQLITE_DONE == rc || SQLITE_ROW == rc) &#123;</span><br><span class="line">        // all is well, let&apos;s return.</span><br><span class="line">    &#125;</span><br><span class="line">    else if (SQLITE_ERROR == rc) &#123;</span><br><span class="line">        NSLog(@&quot;Error calling sqlite3_step (%d: %s) rs&quot;, rc, sqlite3_errmsg([_parentDB sqliteHandle]));</span><br><span class="line">        if (outErr) &#123;</span><br><span class="line">            *outErr = [_parentDB lastError];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else if (SQLITE_MISUSE == rc) &#123;</span><br><span class="line">        // uh oh.</span><br><span class="line">        NSLog(@&quot;Error calling sqlite3_step (%d: %s) rs&quot;, rc, sqlite3_errmsg([_parentDB sqliteHandle]));</span><br><span class="line">        if (outErr) &#123;</span><br><span class="line">            if (_parentDB) &#123;</span><br><span class="line">                *outErr = [_parentDB lastError];</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                // If &apos;next&apos; or &apos;nextWithError&apos; is called after the result set is closed,</span><br><span class="line">                // we need to return the appropriate error.</span><br><span class="line">                NSDictionary* errorMessage = [NSDictionary dictionaryWithObject:@&quot;parentDB does not exist&quot; forKey:NSLocalizedDescriptionKey];</span><br><span class="line">                *outErr = [NSError errorWithDomain:@&quot;FMDatabase&quot; code:SQLITE_MISUSE userInfo:errorMessage];</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        // wtf?</span><br><span class="line">        NSLog(@&quot;Unknown error calling sqlite3_step (%d: %s) rs&quot;, rc, sqlite3_errmsg([_parentDB sqliteHandle]));</span><br><span class="line">        if (outErr) &#123;</span><br><span class="line">            *outErr = [_parentDB lastError];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    if (rc != SQLITE_ROW) &#123;</span><br><span class="line">        [self close];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return (rc == SQLITE_ROW);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="列名与该列的列数的一一对应关系"><a href="#列名与该列的列数的一一对应关系" class="headerlink" title="列名与该列的列数的一一对应关系"></a>列名与该列的列数的一一对应关系</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// 对象中维护了列名与索引一一对应的关系的对照表</span><br><span class="line">- (NSMutableDictionary *)columnNameToIndexMap &#123;</span><br><span class="line">    if (!_columnNameToIndexMap) &#123;</span><br><span class="line">        int columnCount = sqlite3_column_count([_statement statement]);</span><br><span class="line">        _columnNameToIndexMap = [[NSMutableDictionary alloc] initWithCapacity:(NSUInteger)columnCount];</span><br><span class="line">        int columnIdx = 0;</span><br><span class="line">        for (columnIdx = 0; columnIdx &lt; columnCount; columnIdx++) &#123;</span><br><span class="line">            [_columnNameToIndexMap setObject:[NSNumber numberWithInt:columnIdx]</span><br><span class="line">                                      forKey:[[NSString stringWithUTF8String:sqlite3_column_name([_statement statement], columnIdx)] lowercaseString]];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return _columnNameToIndexMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// 根据列名获取该列的所在第几列, 列的索引</span><br><span class="line">- (int)columnIndexForName:(NSString*)columnName &#123;</span><br><span class="line">    columnName = [columnName lowercaseString];</span><br><span class="line">    </span><br><span class="line">    NSNumber *n = [[self columnNameToIndexMap] objectForKey:columnName];</span><br><span class="line">    </span><br><span class="line">    if (n != nil) &#123;</span><br><span class="line">        return [n intValue];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    NSLog(@&quot;Warning: I could not find the column named &apos;%@&apos;.&quot;, columnName);</span><br><span class="line">    </span><br><span class="line">    return -1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 根据列的索引获取该列的名称</span><br><span class="line">// returns autoreleased NSString containing the name of the column in the result set</span><br><span class="line">- (NSString*)columnNameForIndex:(int)columnIdx &#123;</span><br><span class="line">    return [NSString stringWithUTF8String: sqlite3_column_name([_statement statement], columnIdx)];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// 根据列的索引获取该列的值</span><br><span class="line">-xxxForColumn:(NSString*)columnName </span><br><span class="line">// 根据列的名称获取该列的值</span><br><span class="line">-xxxForColumnIndex:(int)columnIdx </span><br><span class="line"></span><br><span class="line">// 封装sqlite3_column_*函数</span><br><span class="line">- (int)intForColumnIndex:(int)columnIdx &#123;</span><br><span class="line">    return sqlite3_column_int([_statement statement], columnIdx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="获取每一行中所有的结果集"><a href="#获取每一行中所有的结果集" class="headerlink" title="获取每一行中所有的结果集"></a>获取每一行中所有的结果集</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/**</span><br><span class="line"> 每一行数据的结果所对应的 Dictionary</span><br><span class="line"></span><br><span class="line"> @return Dictionary</span><br><span class="line"> */</span><br><span class="line">- (NSDictionary*)resultDictionary &#123;</span><br><span class="line">    </span><br><span class="line">    NSUInteger num_cols = (NSUInteger)sqlite3_data_count([_statement statement]);</span><br><span class="line">    </span><br><span class="line">    if (num_cols &gt; 0) &#123;</span><br><span class="line">        NSMutableDictionary *dict = [NSMutableDictionary dictionaryWithCapacity:num_cols];</span><br><span class="line">        </span><br><span class="line">        int columnCount = sqlite3_column_count([_statement statement]);</span><br><span class="line">        </span><br><span class="line">        int columnIdx = 0;</span><br><span class="line">        for (columnIdx = 0; columnIdx &lt; columnCount; columnIdx++) &#123;</span><br><span class="line">            </span><br><span class="line">            NSString *columnName = [NSString stringWithUTF8String:sqlite3_column_name([_statement statement], columnIdx)];</span><br><span class="line">            id objectValue = [self objectForColumnIndex:columnIdx];</span><br><span class="line">            [dict setObject:objectValue forKey:columnName];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return dict;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        NSLog(@&quot;Warning: There seem to be no columns in this set.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return nil;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="kvc支持"><a href="#kvc支持" class="headerlink" title="kvc支持"></a>kvc支持</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// 使用kvc, 把数据库中的每一行的数据对应到每一个对象, 对象的属性要和数据库的列名保持一致</span><br><span class="line">- (void)kvcMagic:(id)object &#123;</span><br><span class="line">    </span><br><span class="line">    int columnCount = sqlite3_column_count([_statement statement]);</span><br><span class="line">    </span><br><span class="line">    int columnIdx = 0;</span><br><span class="line">    for (columnIdx = 0; columnIdx &lt; columnCount; columnIdx++) &#123;</span><br><span class="line">        </span><br><span class="line">        const char *c = (const char *)sqlite3_column_text([_statement statement], columnIdx);</span><br><span class="line">        </span><br><span class="line">        // check for a null row</span><br><span class="line">        if (c) &#123;</span><br><span class="line">            NSString *s = [NSString stringWithUTF8String:c];</span><br><span class="line">            </span><br><span class="line">            [object setValue:s forKey:[NSString stringWithUTF8String:sqlite3_column_name([_statement statement], columnIdx)]];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="FMDatabase的分析"><a href="#FMDatabase的分析" class="headerlink" title="FMDatabase的分析"></a>FMDatabase的分析</h3><h4 id="打开数据库"><a href="#打开数据库" class="headerlink" title="打开数据库"></a>打开数据库</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)open &#123;</span><br><span class="line">    if (_isOpen) &#123;</span><br><span class="line">        return YES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // if we previously tried to open and it failed, make sure to close it before we try again</span><br><span class="line">    </span><br><span class="line">    if (_db) &#123;</span><br><span class="line">        [self close];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // now open database</span><br><span class="line">    </span><br><span class="line">    int err = sqlite3_open([self sqlitePath], (sqlite3**)&amp;_db );</span><br><span class="line">    if(err != SQLITE_OK) &#123;</span><br><span class="line">        NSLog(@&quot;error opening!: %d&quot;, err);</span><br><span class="line">        return NO;</span><br><span class="line">    &#125;</span><br><span class="line">    // 当执行这段代码时候, 数据库正在被其他线程访问, 那我们就需要给他设置一个重试时间, 默认2秒</span><br><span class="line">    if (_maxBusyRetryTimeInterval &gt; 0.0) &#123;</span><br><span class="line">        // set the handler</span><br><span class="line">        [self setMaxBusyRetryTimeInterval:_maxBusyRetryTimeInterval];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    _isOpen = YES;</span><br><span class="line">    </span><br><span class="line">    return YES;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// 设置重试时间, 调用函数 sqlite3_busy_handler(sqlite3, int()(void, int), void);</span><br><span class="line">// 第一个参数: 哪个数据库需要设置 busy handler</span><br><span class="line">// 第二个参数: 回调的busy handler, 其中的第一个参数是 void* 的参数拷贝, 为sqlite3_busy_handler的第三个参数, 第二个参数为int, 表示锁事件, 该回调函数被调用的次数</span><br><span class="line">// 如果回调函数返回0, 将不再阐释再次访问数据库, 返回 SQLITE_BUSY或者SQLITE_IOERR_BLOCKED. 如果返回非0, 将会不断尝试操作数据库</span><br><span class="line">// 程序运行过程中, 如果有其他进程或者线程在读写数据库, 那么sqlite3_busy_handler会不断调用该回调函数, 直到其他线程或者进程释放锁. 获得锁之后, 不会再调用该回调函数, 从而继续向下执行下去, 进行数据库操作. 该函数是在获取不到锁的时候, 以执行回调函数的次数来进行延时, 等待其他进程或者线程操作数据库结束, 从而获得锁进行操作数据库.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (void)setMaxBusyRetryTimeInterval:(NSTimeInterval)timeout &#123;</span><br><span class="line">    </span><br><span class="line">    _maxBusyRetryTimeInterval = timeout;</span><br><span class="line">    </span><br><span class="line">    if (!_db) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    if (timeout &gt; 0) &#123;</span><br><span class="line">        sqlite3_busy_handler(_db, &amp;FMDBDatabaseBusyHandler, (__bridge void *)(self));</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        // turn it off otherwise</span><br><span class="line">        sqlite3_busy_handler(_db, nil, nil);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="查询数据库"><a href="#查询数据库" class="headerlink" title="查询数据库"></a>查询数据库</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line">- (FMResultSet *)executeQuery:(NSString *)sql withArgumentsInArray:(NSArray*)arrayArgs orDictionary:(NSDictionary *)dictionaryArgs orVAList:(va_list)args &#123;</span><br><span class="line">    // 判断数据库是否存在</span><br><span class="line">    if (![self databaseExists]) &#123;</span><br><span class="line">        return 0x00;</span><br><span class="line">    &#125;</span><br><span class="line">    // 判断数据库是否正在使用当中</span><br><span class="line">    if (_isExecutingStatement) &#123;</span><br><span class="line">        [self warnInUse];</span><br><span class="line">        return 0x00;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    _isExecutingStatement = YES;</span><br><span class="line">    </span><br><span class="line">    int rc                  = 0x00;</span><br><span class="line">    sqlite3_stmt *pStmt     = 0x00;</span><br><span class="line">    FMStatement *statement  = 0x00;</span><br><span class="line">    FMResultSet *rs         = 0x00;</span><br><span class="line">    // 打印sql 语句</span><br><span class="line">    if (_traceExecution &amp;&amp; sql) &#123;</span><br><span class="line">        NSLog(@&quot;%@ executeQuery: %@&quot;, self, sql);</span><br><span class="line">    &#125;</span><br><span class="line">    // 获取缓存数据</span><br><span class="line">    if (_shouldCacheStatements) &#123;</span><br><span class="line">        statement = [self cachedStatementForQuery:sql];</span><br><span class="line">        pStmt = statement ? [statement statement] : 0x00;</span><br><span class="line">        [statement reset];</span><br><span class="line">    &#125;</span><br><span class="line">    // 没有缓存数据, 直接查询数据库</span><br><span class="line">    if (!pStmt) &#123;</span><br><span class="line">        // 预处理 sql , 生成pStmt</span><br><span class="line">        rc = sqlite3_prepare_v2(_db, [sql UTF8String], -1, &amp;pStmt, 0);</span><br><span class="line">        </span><br><span class="line">        if (SQLITE_OK != rc) &#123;</span><br><span class="line">            if (_logsErrors) &#123;</span><br><span class="line">                NSLog(@&quot;DB Error: %d \&quot;%@\&quot;&quot;, [self lastErrorCode], [self lastErrorMessage]);</span><br><span class="line">                NSLog(@&quot;DB Query: %@&quot;, sql);</span><br><span class="line">                NSLog(@&quot;DB Path: %@&quot;, _databasePath);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            if (_crashOnErrors) &#123;</span><br><span class="line">                NSAssert(false, @&quot;DB Error: %d \&quot;%@\&quot;&quot;, [self lastErrorCode], [self lastErrorMessage]);</span><br><span class="line">                abort();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            sqlite3_finalize(pStmt);</span><br><span class="line">            _isExecutingStatement = NO;</span><br><span class="line">            return nil;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    id obj;</span><br><span class="line">    int idx = 0;</span><br><span class="line">    int queryCount = sqlite3_bind_parameter_count(pStmt); // pointed out by Dominic Yu (thanks!) // 获取参数个数</span><br><span class="line">    </span><br><span class="line">    // If dictionaryArgs is passed in, that means we are using sqlite&apos;s named parameter support</span><br><span class="line">    if (dictionaryArgs) &#123;</span><br><span class="line">        </span><br><span class="line">        for (NSString *dictionaryKey in [dictionaryArgs allKeys]) &#123;</span><br><span class="line">            </span><br><span class="line">            // Prefix the key with a colon.</span><br><span class="line">            NSString *parameterName = [[NSString alloc] initWithFormat:@&quot;:%@&quot;, dictionaryKey];</span><br><span class="line">            </span><br><span class="line">            if (_traceExecution) &#123;</span><br><span class="line">                NSLog(@&quot;%@ = %@&quot;, parameterName, [dictionaryArgs objectForKey:dictionaryKey]);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // Get the index for the parameter name.</span><br><span class="line">            int namedIdx = sqlite3_bind_parameter_index(pStmt, [parameterName UTF8String]);</span><br><span class="line">            </span><br><span class="line">            FMDBRelease(parameterName);</span><br><span class="line">            </span><br><span class="line">            if (namedIdx &gt; 0) &#123;</span><br><span class="line">                // Standard binding from here.</span><br><span class="line">                [self bindObject:[dictionaryArgs objectForKey:dictionaryKey] toColumn:namedIdx inStatement:pStmt];</span><br><span class="line">                // increment the binding count, so our check below works out</span><br><span class="line">                idx++;</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                NSLog(@&quot;Could not find index for %@&quot;, dictionaryKey);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        </span><br><span class="line">        while (idx &lt; queryCount) &#123;</span><br><span class="line">            </span><br><span class="line">            if (arrayArgs &amp;&amp; idx &lt; (int)[arrayArgs count]) &#123;</span><br><span class="line">                obj = [arrayArgs objectAtIndex:(NSUInteger)idx];</span><br><span class="line">            &#125;</span><br><span class="line">            else if (args) &#123;</span><br><span class="line">                obj = va_arg(args, id);</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                //We ran out of arguments</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            if (_traceExecution) &#123;</span><br><span class="line">                if ([obj isKindOfClass:[NSData class]]) &#123;</span><br><span class="line">                    NSLog(@&quot;data: %ld bytes&quot;, (unsigned long)[(NSData*)obj length]);</span><br><span class="line">                &#125;</span><br><span class="line">                else &#123;</span><br><span class="line">                    NSLog(@&quot;obj: %@&quot;, obj);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            idx++;</span><br><span class="line">            </span><br><span class="line">            [self bindObject:obj toColumn:idx inStatement:pStmt];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // 如果绑定的参数数目不对, 则进行出错处理</span><br><span class="line">    if (idx != queryCount) &#123;</span><br><span class="line">        NSLog(@&quot;Error: the bind count is not correct for the # of variables (executeQuery)&quot;);</span><br><span class="line">        sqlite3_finalize(pStmt);</span><br><span class="line">        _isExecutingStatement = NO;</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    FMDBRetain(statement); // to balance the release below</span><br><span class="line">    // 生成FMStatement 对象</span><br><span class="line">    if (!statement) &#123;</span><br><span class="line">        statement = [[FMStatement alloc] init];</span><br><span class="line">        [statement setStatement:pStmt];</span><br><span class="line">        // 缓存处理, key 为sql 语句, 值为statement</span><br><span class="line">        if (_shouldCacheStatements &amp;&amp; sql) &#123;</span><br><span class="line">            [self setCachedStatement:statement forQuery:sql];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // the statement gets closed in rs&apos;s dealloc or [rs close];</span><br><span class="line">    rs = [FMResultSet resultSetWithStatement:statement usingParentDatabase:self]; // rs是FMResultSet类型的对象</span><br><span class="line">    [rs setQuery:sql];</span><br><span class="line">    </span><br><span class="line">    NSValue *openResultSet = [NSValue valueWithNonretainedObject:rs];</span><br><span class="line">    [_openResultSets addObject:openResultSet]; // 在FMDatabase 中缓存查询后的结果集</span><br><span class="line">    </span><br><span class="line">    [statement setUseCount:[statement useCount] + 1];</span><br><span class="line">    </span><br><span class="line">    FMDBRelease(statement);</span><br><span class="line">    </span><br><span class="line">    _isExecutingStatement = NO;</span><br><span class="line">    </span><br><span class="line">    return rs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>####更新数据库<br>增删改都为更新数据. 类似查询方法.</p>
<h4 id="一次执行多条sql语句"><a href="#一次执行多条sql语句" class="headerlink" title="一次执行多条sql语句"></a>一次执行多条sql语句</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)executeStatements:(NSString *)sql withResultBlock:(__attribute__((noescape)) FMDBExecuteStatementsCallbackBlock)block &#123;</span><br><span class="line">    </span><br><span class="line">    int rc;</span><br><span class="line">    char *errmsg = nil;</span><br><span class="line">    </span><br><span class="line">    rc = sqlite3_exec([self sqliteHandle], [sql UTF8String], block ? FMDBExecuteBulkSQLCallback : nil, (__bridge void *)(block), &amp;errmsg);</span><br><span class="line">    </span><br><span class="line">    if (errmsg &amp;&amp; [self logsErrors]) &#123;</span><br><span class="line">        NSLog(@&quot;Error inserting batch: %s&quot;, errmsg);</span><br><span class="line">    &#125;</span><br><span class="line">    if (errmsg) &#123;</span><br><span class="line">        sqlite3_free(errmsg);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return (rc == SQLITE_OK);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>###FMDB的加密和解密<br>使用 - (BOOL)setKey:(NSString<em>)key; - (BOOL)setKeyWithData:(NSData </em>)keyData; 输入数据库密码验证用户身份; 使用- (BOOL)rekey:(NSString<em>)key; - (BOOL)rekeyWithData:(NSData </em>)keyData; 给数据库设置密码或者清除密码. 是对 sqlite3_key和sqlite3_rekey的封装.</p>
<p>###FMDatabaseAdditions<br>扩展类, 新增对查询结果只返回单个值的方法进行简化, 对表, 列是否存在, 版本号, 校验sql等功能.</p>
<h4 id="xxxForQuery函数"><a href="#xxxForQuery函数" class="headerlink" title="xxxForQuery函数"></a>xxxForQuery函数</h4><p>对查询结果只有一个值的情况进行优化, 有多个值也只取第一个值</p>
<h4 id="数据库的一些概要信息"><a href="#数据库的一些概要信息" class="headerlink" title="数据库的一些概要信息"></a>数据库的一些概要信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)tableExists:(NSString*)tableName; // 数据库是否存在</span><br><span class="line"></span><br><span class="line">- (BOOL)columnExists:(NSString*)columnName inTableWithName:(NSString*)tableName; // 在表中, columnName是否存在</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (FMResultSet * _Nullable)getSchema &#123;</span><br><span class="line">    </span><br><span class="line">    //result colums: type[STRING], name[STRING],tbl_name[STRING],rootpage[INTEGER],sql[STRING]</span><br><span class="line">    FMResultSet *rs = [self executeQuery:@&quot;SELECT type, name, tbl_name, rootpage, sql FROM (SELECT * FROM sqlite_master UNION ALL SELECT * FROM sqlite_temp_master) WHERE type != &apos;meta&apos; AND name NOT LIKE &apos;sqlite_%&apos; ORDER BY tbl_name, type DESC, name&quot;];</span><br><span class="line">    </span><br><span class="line">    return rs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 校验sql 语句是否合法</span><br><span class="line">- (BOOL)validateSQL:(NSString*)sql error:(NSError * _Nullable __autoreleasing *)error</span><br></pre></td></tr></table></figure>
<h3 id="Swift是POP语言"><a href="#Swift是POP语言" class="headerlink" title="Swift是POP语言"></a>Swift是POP语言</h3><p>参考:<br><a href="https://www.jianshu.com/p/255e02337176" target="_blank" rel="noopener">swift标配开源库：Reusable-让你放肆的dequeueReusableCell</a><br><a href="https://juejin.im/entry/589439622f301e00693567e5#comment" target="_blank" rel="noopener">Swift 面向协议编程入门</a><br><a href="https://academy.realm.io/cn/posts/appbuilders-natasha-muraschev-practical-protocol-oriented-programming/" target="_blank" rel="noopener">真刀真枪 面向协议编程</a><br><a href="https://onevcat.com/2016/11/pop-cocoa-1/" target="_blank" rel="noopener">面向协议编程与 Cocoa 的邂逅 (上)</a><br><a href="https://onevcat.com/2016/12/pop-cocoa-2/" target="_blank" rel="noopener">面向协议编程与 Cocoa 的邂逅 (下)</a></p>
</div><div class="tags"></div><div class="post-nav"><a class="pre" href="/2018/10/23/swift中协议的理解和使用/">swift中协议的理解和使用</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/swift/">swift</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/12/24/swift中的struct和class/">swift中的struct和class</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/23/swift中协议的理解和使用/">swift中协议的理解和使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/23/fmdb/">FMDB的分析</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">Run.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>